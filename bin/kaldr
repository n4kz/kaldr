#!/usr/bin/env node
// Generated by CoffeeScript 1.4.0
var Crixalis, argv, frame, optimist, server;

argv = (optimist = require('optimist'))["default"]('port', 8080)["default"]('limit', 256).boolean(['help', 'version', 'agent']).usage(['Usage:', '    kaldr [--port <number>][--limit <number>]'].join('\n')).describe({
  version: 'Show version and exit',
  help: 'Show help and exit',
  port: 'Use specified port',
  agent: 'Append user agent to each message',
  limit: 'Concurrent connections limit'
}).argv;

if (argv.help) {
  optimist.showHelp();
  process.exit();
}

if (argv.version) {
  console.log(require('../package').version);
  process.exit();
}

(Crixalis = require('crixalis')).router({
  methods: ['GET', 'HEAD']
}).from('/kaldr.log').to(function() {
  var message;
  if (this.cookies.message) {
    message = decodeURIComponent(this.cookies.message);
    if (argv.agent) {
      message += ' ' + this.req.headers['user-agent'];
    }
    console.log(message);
  }
  return this.code = 204;
}).from('/kaldr.frame').to(function() {
  this.view = 'html';
  return this.body = frame;
});

Crixalis.on('auto', function() {
  this.headers['Connection'] = 'close';
  return this.select();
});

Crixalis.on('default', function() {
  if (this.is_head || this.is_get) {
    return this.code = 404;
  } else {
    this.code = 405;
    return this.headers['Allowed'] = 'GET, HEAD';
  }
});

Crixalis.self._define('null', function() {});

Crixalis.view = 'null';

frame = "<!DOCTYPE html><script>(function (_, $) {\n	window.onhashchange = function () {\n		var data = _.hash.replace(/^#/, '')\n\n		if (data) {\n			$.cookie = 'message=' + encodeURIComponent(data)\n			(new Image).src = _.href.replace(/frame.*$/, 'log')\n			$.cookie = 'message=; expires=Thu, 01 Jan 1970 00:00:01 GMT;'\n			_.hash = ''\n		}\n	}\n}(location, document))</script>".replace(/\t+/g, '');

server = require('http').createServer(Crixalis.handler).listen(argv.port).on('close', process.exit);

server.maxConnections = argv.limit;

process.on('SIGINT', server.close.bind(server));

process.title = 'kaldr [' + argv.port + ']';
